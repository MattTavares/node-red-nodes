var matrix_font = [
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x18,0x00,0x18,0x18,0x3c,0x3c,0x18],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x6c,0x6c],
    [0x00,0x6c,0x6c,0xfe,0x6c,0xfe,0x6c,0x6c],
    [0x00,0x30,0xf8,0x0c,0x78,0xc0,0x7c,0x30],
    [0x00,0xc6,0x66,0x30,0x18,0xcc,0xc6,0x00],
    [0x00,0x76,0xcc,0xdc,0x76,0x38,0x6c,0x38],
    [0x00,0x00,0x00,0x00,0x00,0xc0,0x60,0x60],
    [0x00,0x18,0x30,0x60,0x60,0x60,0x30,0x18],
    [0x00,0x60,0x30,0x18,0x18,0x18,0x30,0x60],
    [0x00,0x00,0x66,0x3c,0xff,0x3c,0x66,0x00],
    [0x00,0x00,0x30,0x30,0xfc,0x30,0x30,0x00],
    [0x60,0x30,0x30,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00],
    [0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x80,0xc0,0x60,0x30,0x18,0x0c,0x06],
    [0x00,0x7c,0xe6,0xf6,0xde,0xce,0xc6,0x7c],
    [0x00,0xfc,0x30,0x30,0x30,0x30,0x70,0x30],
    [0x00,0xfc,0xcc,0x60,0x38,0x0c,0xcc,0x78],
    [0x00,0x78,0xcc,0x0c,0x38,0x0c,0xcc,0x78],
    [0x00,0x1e,0x0c,0xfe,0xcc,0x6c,0x3c,0x1c],
    [0x00,0x78,0xcc,0x0c,0x0c,0xf8,0xc0,0xfc],
    [0x00,0x78,0xcc,0xcc,0xf8,0xc0,0x60,0x38],
    [0x00,0x30,0x30,0x30,0x18,0x0c,0xcc,0xfc],
    [0x00,0x78,0xcc,0xcc,0x78,0xcc,0xcc,0x78],
    [0x00,0x70,0x18,0x0c,0x7c,0xcc,0xcc,0x78],
    [0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x00],
    [0x60,0x30,0x30,0x00,0x00,0x30,0x30,0x00],
    [0x00,0x18,0x30,0x60,0xc0,0x60,0x30,0x18],
    [0x00,0x00,0xfc,0x00,0x00,0xfc,0x00,0x00],
    [0x00,0x60,0x30,0x18,0x0c,0x18,0x30,0x60],
    [0x00,0x30,0x00,0x30,0x18,0x0c,0xcc,0x78],
    [0x00,0x78,0xc0,0xde,0xde,0xde,0xc6,0x7c],
    [0x00,0xcc,0xcc,0xfc,0xcc,0xcc,0x78,0x30],
    [0x00,0xfc,0x66,0x66,0x7c,0x66,0x66,0xfc],
    [0x00,0x3c,0x66,0xc0,0xc0,0xc0,0x66,0x3c],
    [0x00,0xf8,0x6c,0x66,0x66,0x66,0x6c,0xf8],
    [0x00,0xfe,0x62,0x68,0x78,0x68,0x62,0xfe],
    [0x00,0xf0,0x60,0x68,0x78,0x68,0x62,0xfe],
    [0x00,0x3e,0x66,0xce,0xc0,0xc0,0x66,0x3c],
    [0x00,0xcc,0xcc,0xcc,0xfc,0xcc,0xcc,0xcc],
    [0x00,0x78,0x30,0x30,0x30,0x30,0x30,0x78],
    [0x00,0x78,0xcc,0xcc,0x0c,0x0c,0x0c,0x1e],
    [0x00,0xe6,0x66,0x6c,0x78,0x6c,0x66,0xe6],
    [0x00,0xfe,0x66,0x62,0x60,0x60,0x60,0xf0],
    [0x00,0xc6,0xc6,0xd6,0xfe,0xfe,0xee,0xc6],
    [0x00,0xc6,0xc6,0xce,0xde,0xf6,0xe6,0xc6],
    [0x00,0x38,0x6c,0xc6,0xc6,0xc6,0x6c,0x38],
    [0x00,0xf0,0x60,0x60,0x7c,0x66,0x66,0xfc],
    [0x00,0x1c,0x78,0xdc,0xcc,0xcc,0xcc,0x78],
    [0x00,0xe6,0x66,0x6c,0x7c,0x66,0x66,0xfc],
    [0x00,0x78,0xcc,0x1c,0x70,0xe0,0xcc,0x78],
    [0x00,0x78,0x30,0x30,0x30,0x30,0xb4,0xfc],
    [0x00,0xfc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc],
    [0x00,0x30,0x78,0xcc,0xcc,0xcc,0xcc,0xcc],
    [0x00,0xc6,0xee,0xfe,0xd6,0xc6,0xc6,0xc6],
    [0x00,0xc6,0x6c,0x38,0x38,0x6c,0xc6,0xc6],
    [0x00,0x78,0x30,0x30,0x78,0xcc,0xcc,0xcc],
    [0x00,0xfe,0x66,0x32,0x18,0x8c,0xc6,0xfe],
    [0x00,0x78,0x60,0x60,0x60,0x60,0x60,0x78],
    [0x00,0x02,0x06,0x0c,0x18,0x30,0x60,0xc0],
    [0x00,0x78,0x18,0x18,0x18,0x18,0x18,0x78],
    [0x00,0x00,0x00,0x00,0xc6,0x6c,0x38,0x10],
    [0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    [0x00,0x00,0x00,0x00,0x00,0x18,0x30,0x30],
    [0x00,0x76,0xcc,0x7c,0x0c,0x78,0x00,0x00],
    [0x00,0xdc,0x66,0x66,0x7c,0x60,0x60,0xe0],
    [0x00,0x78,0xcc,0xc0,0xcc,0x78,0x00,0x00],
    [0x00,0x76,0xcc,0xcc,0x7c,0x0c,0x0c,0x1c],
    [0x00,0x78,0xc0,0xfc,0xcc,0x78,0x00,0x00],
    [0x00,0xf0,0x60,0x60,0xf0,0x60,0x6c,0x38],
    [0xf8,0x0c,0x7c,0xcc,0xcc,0x76,0x00,0x00],
    [0x00,0xe6,0x66,0x66,0x76,0x6c,0x60,0xe0],
    [0x00,0x78,0x30,0x30,0x30,0x70,0x00,0x30],
    [0x78,0xcc,0xcc,0x0c,0x0c,0x0c,0x00,0x0c],
    [0x00,0xe6,0x6c,0x78,0x6c,0x66,0x60,0xe0],
    [0x00,0x78,0x30,0x30,0x30,0x30,0x30,0x70],
    [0x00,0xc6,0xd6,0xfe,0xfe,0xcc,0x00,0x00],
    [0x00,0xcc,0xcc,0xcc,0xcc,0xf8,0x00,0x00],
    [0x00,0x78,0xcc,0xcc,0xcc,0x78,0x00,0x00],
    [0xf0,0x60,0x7c,0x66,0x66,0xdc,0x00,0x00],
    [0x1e,0x0c,0x7c,0xcc,0xcc,0x76,0x00,0x00],
    [0x00,0xf0,0x60,0x66,0x76,0xdc,0x00,0x00],
    [0x00,0xf8,0x0c,0x78,0xc0,0x7c,0x00,0x00],
    [0x00,0x18,0x34,0x30,0x30,0x7c,0x30,0x10],
    [0x00,0x76,0xcc,0xcc,0xcc,0xcc,0x00,0x00],
    [0x00,0x30,0x78,0xcc,0xcc,0xcc,0x00,0x00],
    [0x00,0x6c,0xfe,0xfe,0xd6,0xc6,0x00,0x00],
    [0x00,0xc6,0x6c,0x38,0x6c,0xc6,0x00,0x00],
    [0xf8,0x0c,0x7c,0xcc,0xcc,0xcc,0x00,0x00],
    [0x00,0xfc,0x64,0x30,0x98,0xfc,0x00,0x00],
    [0x00,0x1c,0x30,0x30,0xe0,0x30,0x30,0x1c],
    [0x00,0x18,0x18,0x18,0x00,0x18,0x18,0x18],
    [0x00,0xe0,0x30,0x30,0x1c,0x30,0x30,0xe0],
    [0x00,0x00,0x00,0x00,0x00,0x00,0xdc,0x76],
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
];

module.exports = function(flotilla, args, channel, module){
    var buffer = [
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        128
    ];

    function update(){
        flotilla.updateModule(channel, buffer);        
    }

    function set_pixel(x, y, value){
        if(typeof x !== "number" || typeof y !== "number") return;

        if(value){
            buffer[7-x] |= (1 << y);
        }
        else
        {
            buffer[7-x] &= ~(1 << y); 
        }
    }

    function set_number(value){
        if(typeof value !== "number") return;

        value = Math.min(value, 9); // Clamp to 0-9
        value = Math.max(value, 0);

        set_letter(value.toString());
    }

    function set_letter(value){
        if(typeof value !== "string") return;

        var charCode = value.charCodeAt(0);

        var charMap = matrix_font[charCode];

        for(var x = 0; x < 8; x++){
            buffer[x] = charMap[x];
        }
    }

    function set_brightness(value){
        buffer[8] = brightness & 0xff;
    }

    return {
        output: {
            set_pixel: function(x, y, value) {set_pixel(x, y, value);},
            set_number: function(value) {set_number(value);},
            set_letter: function(value) {set_letter(value);},
            show: function(value) {update();}
        }
    };
}
